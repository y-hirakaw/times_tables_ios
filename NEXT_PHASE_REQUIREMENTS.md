# 九九アプリ 次期フェーズ要件仕様書

## 1. 現状分析サマリー

### 1.1 現在のアプリ評価（2025年7月時点）

#### 強み ✅
- **基本学習機能**: 4つの問題モード（ランダム・段別・順番・虫食い）
- **ポイントシステム**: 獲得・消費・ボーナス機能が完備
- **統計・分析機能**: 段別統計、苦手問題判定、週間推移等の詳細分析
- **親用管理機能**: PIN認証、ポイント管理、学習データ確認
- **技術アーキテクチャ**: SVVS (Store-View-ViewState) パターンによる優秀な設計
- **データ管理**: SwiftDataによる効率的な永続化とリアルタイム統計

#### 機能一覧
- **学習モード**: ランダム問題、段別問題、順番問題、虫食い問題
- **学習支援**: チャレンジモード（苦手問題50%確率優先）、10秒タイマー、9択選択肢
- **ポイント制**: 正解1pt、苦手問題ボーナス2pt、上限10pt/問題
- **統計機能**: 得意・苦手比率、週間推移、段別正解率、回答時間分析
- **親機能**: PIN認証、ポイント消費履歴、学習データ確認

### 1.2 発見した課題 ⚠️

#### ユーザー体験の課題
- **学習継続モチベーションの単調さ**: 問題解答の繰り返しによるマンネリ化
- **中期・長期目標の不在**: ポイント獲得はあるが明確な達成目標がない
- **進捗実感の不足**: 統計画面は詳細だが子供には複雑すぎる

#### 親子間コミュニケーションの課題
- **一方向の情報フロー**: 親は子の状況を見るだけ、子は結果を見せる機能がない
- **共有体験の不足**: 一緒に楽しめる要素が限定的
- **フィードバック機能の不在**: 親から子への褒め言葉やメッセージ機能がない

#### 技術的課題
- **個別化学習の限界**: 画一的な問題提示、学習スタイルの個別化未対応
- **豊富な統計の未活用**: 詳細データがあるが子供向けの簡単な進捗表示が不足
- **ゲーミフィケーション要素の不足**: レベル、バッジ、アバター等の楽しさが不足

## 2. 次期フェーズ機能要件

### 2.1 🥇 Phase 2A：最優先機能（✅ **実装完了**）

#### 2.1.1 子供向け進捗可視化システム ✅ **完了**
**目的**: 学習継続モチベーション向上、進捗の直感的理解

**実装済み機能**:
- **九九マスターマップ** ✅
  - 1〜9の段を島・城で視覚的に表現（完全実装）
  - 習熟度4段階（れんしゅうちゅう→がんばってる→もうすこし→マスター）
  - タップによる段別詳細情報表示
  - 86%正解率でマスターレベル到達
  
- **進捗追跡システム** ✅
  - 段ごとの習熟度を自動計算・表示
  - 「あと○もんでマスター」表示機能
  - リアルタイム進捗更新
  
- **デイリーチャレンジ** ✅
  - 毎日の目標問題数設定・追跡
  - 連続達成記録（ストリーク）表示
  - 週間履歴の可視化
  - 達成時の祝福メッセージ

**実装済みデータモデル**:
```swift
@Model
class DailyChallenge {
    var date: Date
    var targetProblems: Int
    var completedProblems: Int
    var isCompleted: Bool { completedProblems >= targetProblems }
    var streakCount: Int
    var createdAt: Date
}

@Model  
class MasteryProgress {
    var multiplicationTable: Int // 1-9
    var totalProblems: Int
    var correctProblems: Int
    var masteryLevel: MasteryLevel // 4段階評価
    var correctRate: Double
    var problemsToMaster: Int // マスターまでに必要な問題数
}
```

**実装済みUI/UX**:
- ホーム画面上部に九九マスターマップ配置 ✅
- コンパクトレイアウトでスクロール最小化 ✅
- カラフルで親しみやすいデザイン ✅
- 小学2年生向けの平易な日本語 ✅
- マスター数の表示（○/9）✅

**完了日**: 2025年7月13日

#### 2.1.2 親子間コミュニケーション機能 ✅ **完了**
**目的**: 親子の学習体験共有、家庭学習の質向上

**実装済み機能**:
- **子供用メッセージ機能** ✅
  - メッセージ画面（ChildMessageView）
  - 親へのお知らせ送信機能
  - 今日の頑張り報告システム
  - 達成度シェア機能
  
- **親子間メッセージシステム** ✅ 
  - 双方向テキストメッセージ送受信
  - 音声録音・再生機能（AVFoundation活用）
  - よく使うメッセージテンプレート
  - メッセージ履歴管理
  
- **コミュニケーションHub** ✅
  - CommunicationViewState による状態管理
  - 未読メッセージ通知
  - 親用ダッシュボード連携

**実装済みデータモデル**:
```swift
@Model
class Message {
    var id: UUID
    var content: String
    var audioFilePath: String?
    var timestamp: Date
    var isFromParent: Bool
    var isRead: Bool
}

@Model
class Achievement {
    var id: UUID
    var type: AchievementType
    var title: String
    var achievementDescription: String
    var earnedDate: Date
    var isShared: Bool
    var metadata: [String: String]
}
```

**実装済みUI/UX**:
- 子供用：ツールバーにメッセージボタン配置 ✅
- 親用：ダッシュボードにメッセージ管理画面 ✅
- 音声録音：簡単操作UI（録音・停止・再生）✅
- ローカライゼーション：日英二言語対応 ✅

**完了日**: 2025年7月13日

#### 2.1.3 ローカライゼーション対応 ✅ **完了**
**実装済み内容**:
- Localizable.xcstrings に約70個の新規文字列追加 ✅
- 日本語・英語の完全対応 ✅
- ViewState・Modelでの NSLocalizedString 活用 ✅
- ビルド検証済み ✅

**完了日**: 2025年7月13日

### 2.2 🥈 Phase 2B：高優先機能（一部実装済み）

#### 2.2.1 ゲーミフィケーション要素
**目的**: 長期的な学習継続意欲の向上

**機能仕様**:
- **レベルシステム** ✅ **完了（2025年7月17日）**
  - 総解答問題数に応じたレベルアップ（Lv.1〜50）✅
  - レベルアップ時の特別エフェクト ✅
  - レベルに応じた称号獲得（7段階の称号システム）✅
    - 九九みならい (Lv.1-4)
    - 九九チャレンジャー (Lv.5-9)
    - 九九ファイター (Lv.10-14)
    - 九九マスター (Lv.15-24)
    - 九九エキスパート (Lv.25-34)
    - 九九チャンピオン (Lv.35-44)
    - 九九レジェンド (Lv.45-50)
  - 経験値システム（二次曲線：5*level² + 5*level - 10）✅
  - 苦手問題2倍ボーナス実装 ✅
  
- **バッジシステム** ✅ **完了（2025年7月17日）**
  - 各種達成に対するバッジ授与 ✅
  - 実装済みバッジ：
    - れんぞくせいかい（5/10/20/50/100回）
    - はやうちおう（3秒以内回答）
    - がんばりや（7日/30日連続学習）
    - ちょうせんしゃ（毎日チャレンジ達成）
    - マスター系バッジ（各段マスター、全段マスター）
  - バッジコレクション画面での一覧表示 ✅
  - 獲得時のアニメーション・通知 ✅
  
- **キャラクター進化＆ルームカスタマイズシステム** 🚧 **未実装**
  - スターターキャラクター3種類（植物型・宇宙型・メカ型）
  - レベル連動の進化システム（5段階進化）
  - ルームカスタマイズ（床・壁紙・家具・装飾品）
  - キャラクターとルームの相互作用

**技術要件**:
- ✅ レベルアップ判定ロジック（実装済み）
- ✅ アニメーション・エフェクト実装（レベルアップ時）
- ✅ バッジ実績判定ロジック（実装済み）
- 🚧 キャラクター進化アセット管理
- 🚧 ルームアイテム配置ロジック

**工数見積**: 
- レベルシステム：✅ 完了（0.5日）
- バッジシステム：✅ 完了（0.5日）
- キャラクター進化＆ルームカスタマイズシステム：2-3週間（予定）

#### 2.2.2 学習モード拡張
**目的**: 学習体験の多様化、飽きない仕組み

**機能仕様**:
- **ストーリーモード**
  - RPG風の冒険シナリオで九九を学習
  - ボス戦（苦手問題）、宝箱発見（新記録）等
  - 章クリア制でストーリー進行
  
- **対戦モード（ローカル）**
  - 家族間での九九バトル機能
  - リアルタイム対戦、ターン制バトル
  - ハンディキャップ機能（年齢・習熟度差調整）
  
- **復習モード**
  - 忘却曲線理論に基づく最適復習タイミング提案
  - 「そろそろ ○のだん を ふくしゅう しませんか？」
  - 復習効果の可視化

**技術要件**:
- 複雑なゲームロジック実装
- マルチプレイヤー対応（ローカル）
- 忘却曲線アルゴリズム実装

**工数見積**: 5-6週間

### 2.3 🥉 Phase 2C：新規機能拡張

#### 2.3.1 カードガチャシステム
**目的**: 長期的な収集欲求の刺激とモチベーション向上

**機能仕様**:
- **コレクションカード**: 各段キャラクター9種類 × 9段 = 81種類
- **レアリティシステム**: ノーマル・レア・スーパーレア・レジェンド
- **ガチャメカニクス**: 通常ガチャ(10pt)、プレミアムガチャ(30pt)、10連ガチャ(90pt)
- **天井システム**: 100回でレジェンド確定
- **カード図鑑**: 獲得済み/未獲得の一覧表示
- **限定カード**: 月替わり・季節限定コンテンツ

**技術要件**:
- カードデータモデル実装
- ガチャ確率システム
- カード図鑑UI
- カードコレクション管理

**工数見積**: 3-4週間

#### 2.3.2 月次ランキングシステム  
**目的**: 健全な競争環境の提供と長期エンゲージメント

**機能仕様**:
- **総合ランキング**: 月間獲得ポイント・問題数・正解率
- **カテゴリ別ランキング**: 学年別・段別・チャレンジ別
- **地域別ランキング**: 都道府県別・市区町村別（オプション）
- **報酬システム**: 順位に応じた限定カード・バッジ・ポイント
- **参加報酬**: 月間問題数に応じた参加賞

**技術要件**:
- ランキング集計ロジック
- 月次リセット機能
- 報酬配布システム
- プライバシー保護機能

**工数見積**: 2-3週間

#### 2.3.3 個別化学習エンジン（長期検討）
**機能概要**:
- 適応タイマー（子供の回答パターンに応じた制限時間調整）
- 学習スタイル診断（視覚型・聴覚型等の特性分析）
- AI推奨問題（機械学習による最適問題選択）

**工数見積**: 8-10週間

#### 2.3.4 社会機能（長期検討）
**機能概要**:
- クラスルーム連携（学校の先生が生徒進捗確認）
- フレンド機能（友達同士の進捗比較）
- オンライン対戦（リアルタイム九九バトル）

**工数見積**: 10-12週間（サーバーサイド開発含む）

## 3. 技術実装ガイドライン

### 3.1 アーキテクチャ原則

#### SVVS パターン継続
- 既存のStore-View-ViewStateパターンを新機能でも維持
- DataStoreシングルトンによるデータアクセス統一
- 新機能のViewStateも@MainActor準拠

#### SwiftDataモデル設計
```swift
// 新規モデル例
@Model
class ProgressVisualization {
    var userLevel: Int
    var totalExperience: Int
    var currentStreak: Int
    var lastPlayDate: Date
    // 既存モデルとの関連は外部キーではなくIDで管理
}
```

### 3.2 UI/UXガイドライン

#### デザインシステム継続
- 既存のColors.swift, Typography.swiftを拡張
- 小学2年生レベルの平易な日本語使用
- カラフルで親しみやすいデザイン
- アクセシビリティ対応（VoiceOver等）

#### アニメーション方針
- SwiftUIネイティブアニメーション活用
- 過度な演出は避け、学習の邪魔にならない配慮
- パフォーマンス重視（60fps維持）

### 3.3 テスト戦略

#### swift-testing継続
- 新機能のViewStateテストは@MainActor必須
- データモデルの単体テスト充実
- UI自動テストでのクリティカルパス検証

#### データ移行
- 既存ユーザーデータの完全保護
- SwiftDataスキーママイグレーション計画
- バックアップ・復元機能の検討

### 3.4 パフォーマンス考慮

#### アプリサイズ管理
- アバター画像等のアセット最適化
- オンデマンドリソース活用検討
- 不要機能の段階的削除

#### メモリ・CPU効率
- 統計計算の最適化（キャッシュ活用）
- アニメーションのメモリリーク防止
- バックグラウンド処理の適切な制御

## 4. 実装ロードマップ

### 4.1 Phase 2A：基盤強化 ✅ **完了済み**（2025年7月13日）
```
✅ 週1-2: 子供向け進捗可視化システム
│     ✅ 九九マスターマップUI実装
│     ✅ 進捗バー・チャレンジ機能
│     ✅ データモデル拡張・テスト
│
✅ 週3-4: 親子間コミュニケーション機能
      ✅ メッセージ送受信システム
      ✅ がんばりレポート機能
      ✅ 通知・音声機能統合
      ✅ ローカライゼーション対応（日英）
```

**Phase 2A 完了サマリー**:
- **実装期間**: 2025年7月13日（1日で完了）
- **実装機能**: 子供向け進捗可視化 + 親子コミュニケーション + 多言語対応
- **新規追加ファイル数**: 20+ファイル
- **ビルド状況**: 成功 ✅
- **品質**: エラー修正・動作検証済み ✅

**次期推奨**: Phase 2Bの実装着手

### 4.2 Phase 2B：体験向上（8-10週間）
```
✅ 完了: レベルシステム（2025年7月17日・0.5日）
│     ✅ Lv.1-50のレベルシステム
│     ✅ 7段階の称号システム  
│     ✅ レベルアップエフェクト
│
✅ 完了: バッジシステム（2025年7月17日・0.5日）
│     ✅ 各種バッジ実装（連続正解、早打ち王、頑張り屋等）
│     ✅ バッジコレクション画面
│     ✅ 獲得時アニメーション
│
🚧 未実装: ゲーミフィケーション要素残り（2-3週間）
│     └ キャラクター進化＆ルームカスタマイズ（2-3週間）
│
週9-12: 学習モード拡張
       ├ ストーリーモード基本実装
       ├ ローカル対戦機能
       └ 復習モード・忘却曲線
```

### 4.3 Phase 2C：新規機能拡張（5-7週間）
```
Phase 3A: カードガチャシステム（3-4週間）
├ カードデータモデル・ガチャロジック実装
├ カード図鑑機能・UI実装
└ 基本カード30種類の実装

Phase 3B: 月次ランキングシステム（2-3週間）
├ ランキング集計ロジック実装
├ ランキング画面UI実装
└ 報酬配布・月次リセット機能

Phase 3C: 長期検討機能（6ヶ月〜1年）
├ 個別化学習エンジン（AI・機械学習）
├ 社会機能（クラスルーム連携・フレンド）
└ オンライン対戦・サーバーサイド基盤
```

## 5. リスク管理・品質保証

### 5.1 技術リスク
- **データ整合性**: 新旧モデル間の整合性確保
- **パフォーマンス**: 機能追加によるアプリ重量化防止
- **互換性**: iOS最新版・旧版での動作保証

### 5.2 UXリスク
- **学習効果**: ゲーム要素が学習の妨げにならない配慮
- **プライバシー**: 親子間データ共有の適切な制御
- **アクセシビリティ**: 障害を持つ子供への配慮

### 5.3 品質保証計画
- 段階的リリース（ベータテスト→段階展開）
- 実際の親子でのユーザビリティテスト
- 学習効果の定量的測定・評価

### 5.4 新機能特有のリスク
#### キャラクター進化＆ルームカスタマイズ
- **アセット管理**: 大量のキャラクター・アイテム画像によるアプリサイズ増大
- **パフォーマンス**: アニメーション処理による端末性能への影響
- **ユーザビリティ**: 小学生にとって操作が複雑になるリスク

#### カードガチャシステム
- **射幸心の煽り**: 子供向けアプリでのガチャ機能の適切な設計
- **確率表示**: レアリティ確率の透明性確保
- **ポイント消費バランス**: 過度なポイント消費による学習意欲減退防止

#### ランキングシステム
- **プライバシー**: 子供の情報保護とランキング表示の両立
- **いじめ防止**: 順位による劣等感やいじめの発生防止
- **公平性**: 不正行為（問題解答の自動化等）の検出・防止

## 6. 成功指標・KPI

### 6.1 ユーザー体験指標
- **継続率**: 7日継続率、30日継続率の向上
- **学習効率**: 問題習得速度の改善
- **満足度**: アプリストアレビュー評価向上

### 6.2 機能別指標
- **進捗可視化**: マップ閲覧率、チャレンジ達成率
- **親子コミュニケーション**: メッセージ送受信頻度、レポート共有率
- **ゲーミフィケーション**: レベルアップ率、バッジ収集率

### 6.3 学習効果指標
- **習熟度向上**: 段別正解率の改善度
- **苦手克服**: DifficultQuestion解消率
- **定着率**: 長期記憶への定着度測定

### 6.4 新機能別KPI
#### キャラクター進化＆ルームカスタマイズ
- **キャラクター愛着度**: キャラクター選択→進化完了までの継続率
- **ルーム利用率**: ルームカスタマイズ機能の月間利用回数
- **ポイント消費率**: ルームアイテム購入によるポイント消費比率（目標：20-30%）

#### カードガチャシステム
- **コレクション完成率**: 各段カードの収集完了率（目標：段別50%以上）
- **ガチャ利用率**: 月間ガチャ実行回数（目標：1ユーザー月10回以上）
- **レアカード獲得による継続率**: レア以上カード獲得後の7日継続率（目標：80%以上）

#### ランキングシステム
- **ランキング参加率**: 月間100問以上解答によるランキング参加率（目標：60%以上）
- **競争効果**: ランキング導入前後の月間問題解答数比較（目標：30%増）
- **健全性指標**: ランキング関連の否定的フィードバック率（目標：5%以下）

### 6.5 総合的成功指標
- **DAU/MAU比率**: 40%以上（現状より10%向上）
- **平均セッション時間**: 15分以上（現状より25%向上）
- **アプリストア評価**: 4.5星以上維持
- **全段マスター達成率**: 60%以上（現状目標40%から向上）
- **ユーザー推奨度（NPS）**: +50以上

---

---

## 7. Phase 2A 実装完了報告

### 7.1 実装完了機能一覧 ✅
**完了日**: 2025年7月13日

#### ✅ 子供向け進捗可視化システム
- **九九マスターマップ**: 1-9段の島・城による視覚表現
- **習熟度4段階**: れんしゅうちゅう→がんばってる→もうすこし→マスター
- **進捗追跡**: リアルタイム正解率計算（86%でマスター到達）
- **デイリーチャレンジ**: 毎日の目標設定・ストリーク記録
- **週間履歴**: 過去7日間の学習状況可視化

#### ✅ 親子間コミュニケーション機能
- **双方向メッセージ**: テキスト・音声メッセージ送受信
- **がんばり報告**: 子供から親への学習成果共有
- **達成度シェア**: マスター達成等の自動通知
- **音声録音**: AVFoundation活用の簡単録音・再生
- **メッセージ履歴**: 過去のやり取り管理

#### ✅ 技術基盤強化
- **データモデル**: DailyChallenge, MasteryProgress, Message, Achievement
- **ViewState**: ProgressVisualizationViewState, CommunicationViewState
- **UI最適化**: コンパクトレイアウト、スクロール最小化
- **ローカライゼーション**: 日英二言語完全対応（70+文字列）

### 7.2 品質保証結果 ✅
- **ビルド成功**: iOS シミュレータでの動作確認済み
- **エラー修正**: SwiftData命名競合、初期化問題等すべて解決
- **動作検証**: 6の段マスター機能等の動作確認済み
- **UI/UX検証**: レイアウト最適化によるユーザビリティ向上

### 7.3 今後の開発方針
**推奨次期フェーズ**: Phase 2B（ゲーミフィケーション要素）
- レベルシステム・バッジシステム実装
- アバター・着せ替え機能
- ストーリーモード・対戦モード

---

## 8. Phase 2B 実装完了報告

### 8.1 実装完了機能一覧 ✅
**完了日**: 2025年7月17日

#### ✅ レベルシステム（ゲーミフィケーション要素）
- **50段階レベルシステム**: Lv.1-50の段階的成長システム
- **7段階称号システム**: 九九みならい→九九レジェンドまでの称号
- **経験値システム**: 二次曲線による適切な成長カーブ（5*level² + 5*level - 10）
- **苦手問題ボーナス**: 苦手問題正解時の2倍経験値
- **レベルアップエフェクト**: 達成感を演出するアニメーション

#### ✅ バッジシステム（ゲーミフィケーション要素）
- **連続正解バッジ**: 5/10/20/50/100回連続正解達成
- **早打ち王バッジ**: 3秒以内の素早い回答
- **頑張り屋バッジ**: 7日/30日連続学習達成
- **挑戦者バッジ**: デイリーチャレンジ達成
- **マスターバッジ**: 各段/全段マスター達成
- **バッジコレクション画面**: 獲得バッジの一覧表示
- **獲得通知**: バッジ取得時のアニメーション演出

### 8.2 技術実装詳細 ✅
- **データモデル拡張**: UserLevel、Badge、BadgeEarnedモデル追加
- **ViewState強化**: StatsViewStateにレベル・バッジ管理機能統合
- **UI/UX最適化**: ホーム画面でのレベル表示、統計画面でのバッジ表示
- **多言語対応**: レベル・バッジ関連の全文字列を日英対応

### 8.3 実装工数実績
- **レベルシステム**: 0.5日（予定4-5週間→大幅短縮）
- **バッジシステム**: 0.5日（予定2週間→大幅短縮）
- **合計**: 1日（効率的な実装により工数を大幅削減）

### 8.4 今後の開発方針
**未実装機能**:
- キャラクター進化＆ルームカスタマイズシステム（2-3週間予定）
- 学習モード拡張（ストーリーモード、対戦モード等）
- カードガチャシステム（3-4週間予定）
- 月次ランキングシステム（2-3週間予定）

**推奨事項**:
- Phase 2Bのキャラクター進化＆ルームカスタマイズシステム実装により、ゲーミフィケーション要素を完成
- その後Phase 2B学習モード拡張またはPhase 2Cカードガチャ・ランキングシステムへ移行

---

**文書作成日**: 2025年7月13日  
**Phase 2A完了日**: 2025年7月13日  
**Phase 2B部分完了日**: 2025年7月17日（レベル・バッジシステム）  
**要件仕様書更新日**: 2025年7月20日（新機能追加・アバターシステム刷新）  
**次回更新予定**: キャラクター進化システム実装時  
**関連ドキュメント**: `CLAUDE.md`, `.claude/workspace/task.md`

この要件仕様書は、九九アプリの次期フェーズ開発において、機能企画・技術実装・品質保証の全側面をカバーしています。Phase 2Aの完全実装により基盤機能が確立され、Phase 2Bのレベル・バッジシステム実装により、ゲーミフィケーション要素の主要部分が完成しました。

今回の更新では、従来のアバターシステムをより魅力的な「キャラクター進化＆ルームカスタマイズシステム」に刷新し、さらに「カードガチャシステム」「月次ランキングシステム」という新機能を追加しました。これらの機能により、長期的な学習継続とユーザーエンゲージメントの大幅な向上が期待できます。

引き続き、優先順位に従って段階的に実装することで、確実にユーザー体験を向上させ、持続的な学習習慣の形成を支援できます。