# 九九アプリ 次期フェーズ要件仕様書

## 1. 現状分析サマリー

### 1.1 現在のアプリ評価（2025年7月時点）

#### 強み ✅
- **基本学習機能**: 4つの問題モード（ランダム・段別・順番・虫食い）
- **ポイントシステム**: 獲得・消費・ボーナス機能が完備
- **統計・分析機能**: 段別統計、苦手問題判定、週間推移等の詳細分析
- **親用管理機能**: PIN認証、ポイント管理、学習データ確認
- **技術アーキテクチャ**: SVVS (Store-View-ViewState) パターンによる優秀な設計
- **データ管理**: SwiftDataによる効率的な永続化とリアルタイム統計

#### 機能一覧
- **学習モード**: ランダム問題、段別問題、順番問題、虫食い問題
- **学習支援**: チャレンジモード（苦手問題50%確率優先）、10秒タイマー、9択選択肢
- **ポイント制**: 正解1pt、苦手問題ボーナス2pt、上限10pt/問題
- **統計機能**: 得意・苦手比率、週間推移、段別正解率、回答時間分析
- **親機能**: PIN認証、ポイント消費履歴、学習データ確認

### 1.2 発見した課題 ⚠️

#### ユーザー体験の課題
- **学習継続モチベーションの単調さ**: 問題解答の繰り返しによるマンネリ化
- **中期・長期目標の不在**: ポイント獲得はあるが明確な達成目標がない
- **進捗実感の不足**: 統計画面は詳細だが子供には複雑すぎる

#### 親子間コミュニケーションの課題
- **一方向の情報フロー**: 親は子の状況を見るだけ、子は結果を見せる機能がない
- **共有体験の不足**: 一緒に楽しめる要素が限定的
- **フィードバック機能の不在**: 親から子への褒め言葉やメッセージ機能がない

#### 技術的課題
- **個別化学習の限界**: 画一的な問題提示、学習スタイルの個別化未対応
- **豊富な統計の未活用**: 詳細データがあるが子供向けの簡単な進捗表示が不足
- **ゲーミフィケーション要素の不足**: レベル、バッジ、アバター等の楽しさが不足

## 2. 次期フェーズ機能要件

### 2.1 🥇 Phase 2A：最優先機能（即座実装推奨）

#### 2.1.1 子供向け進捗可視化システム
**目的**: 学習継続モチベーション向上、進捗の直感的理解

**機能仕様**:
- **九九マスターマップ**
  - 1〜9の段を島や城で視覚的に表現
  - クリア状況に応じて色変化（未学習→学習中→マスター）
  - タップすると段別の詳細情報表示
  
- **簡単進捗バー**
  - 「3のだん あと○もんで かんせい！」形式の分かりやすい表示
  - 段ごとの習熟度を視覚的プログレスバーで表現
  - 完了予測「あと○にちで できそう！」
  
- **デイリーチャレンジ**
  - 「きょうは 5もん といてみよう」等の小目標設定
  - 達成時の特別エフェクト・効果音
  - 連続達成記録の表示

**技術要件**:
- SwiftUI Charts拡張による新しい可視化コンポーネント
- 既存のAnswerTimeRecord、DifficultQuestionデータ活用
- 新規ViewState: ProgressVisualizationViewState
- アニメーション: SwiftUIのwithAnimation活用

**データモデル拡張**:
```swift
@Model
class DailyChallenge {
    var date: Date
    var targetProblems: Int
    var completedProblems: Int
    var isCompleted: Bool
    var streakCount: Int
}

@Model  
class MasteryProgress {
    var multiplicationTable: Int // 1-9
    var totalProblems: Int
    var masteredProblems: Int
    var masteryLevel: MasteryLevel // .beginner, .intermediate, .advanced, .master
}
```

**UI/UX仕様**:
- ホーム画面上部に九九マスターマップ配置
- カラフルで親しみやすいデザイン
- タップ・スワイプによる直感的操作
- 小学2年生でも理解できる平易な日本語

**工数見積**: 2-3週間

#### 2.1.2 親子間コミュニケーション機能
**目的**: 親子の学習体験共有、家庭学習の質向上

**機能仕様**:
- **がんばりレポート（子→親）**
  - 学習セッション終了時に「きょうの がんばり」を親に報告
  - 解いた問題数、新しくできるようになった問題の表示
  - 子供が選択できる「きょうの きもち」絵文字
  
- **親からのメッセージ機能**
  - 親が子供にテキスト・音声メッセージを送信
  - 事前定義された褒め言葉テンプレート提供
  - 目標達成時の自動励ましメッセージ
  
- **共有アチーブメント通知**
  - 子供の重要な達成（段マスター等）を親に自動通知
  - 親子で一緒に喜べる特別演出機能

**技術要件**:
- 新規データモデル: Message, Achievement
- ローカル通知（UserNotifications）
- 音声録音・再生（AVFoundation）
- 既存のPINManager拡張

**データモデル拡張**:
```swift
@Model
class Message {
    var id: UUID
    var fromParent: Bool
    var content: String
    var audioURL: URL?
    var timestamp: Date
    var isRead: Bool
    var achievementId: UUID?
}

@Model
class Achievement {
    var id: UUID
    var type: AchievementType
    var title: String
    var description: String
    var earnedDate: Date
    var isShared: Bool
}
```

**UI/UX仕様**:
- 子供用：学習終了画面にレポート送信ボタン
- 親用：ダッシュボードにメッセージ履歴画面
- 通知：控えめで邪魔にならないデザイン
- 音声：最大30秒、簡単録音・再生UI

**工数見積**: 2-3週間

### 2.2 🥈 Phase 2B：高優先機能

#### 2.2.1 ゲーミフィケーション要素
**目的**: 長期的な学習継続意欲の向上

**機能仕様**:
- **レベルシステム**
  - 総解答問題数に応じたレベルアップ（Lv.1〜50）
  - レベルアップ時の特別エフェクト・BGM
  - レベルに応じた称号獲得（「九九みならい」→「九九マスター」）
  
- **バッジシステム**
  - 各種達成に対するバッジ授与
  - 例：「れんぞく せいかい 10かい」「はやうち おう」「がんばりや」
  - バッジコレクション画面での一覧表示
  
- **アバターシステム**
  - ポイントで購入できる衣装・アクセサリー
  - 季節限定アイテム（お正月、夏祭り等）
  - アバター着せ替え画面

**技術要件**:
- 複雑な実績判定ロジック
- アニメーション・エフェクト実装
- アバター画像アセット管理

**工数見積**: 4-5週間

#### 2.2.2 学習モード拡張
**目的**: 学習体験の多様化、飽きない仕組み

**機能仕様**:
- **ストーリーモード**
  - RPG風の冒険シナリオで九九を学習
  - ボス戦（苦手問題）、宝箱発見（新記録）等
  - 章クリア制でストーリー進行
  
- **対戦モード（ローカル）**
  - 家族間での九九バトル機能
  - リアルタイム対戦、ターン制バトル
  - ハンディキャップ機能（年齢・習熟度差調整）
  
- **復習モード**
  - 忘却曲線理論に基づく最適復習タイミング提案
  - 「そろそろ ○のだん を ふくしゅう しませんか？」
  - 復習効果の可視化

**技術要件**:
- 複雑なゲームロジック実装
- マルチプレイヤー対応（ローカル）
- 忘却曲線アルゴリズム実装

**工数見積**: 5-6週間

### 2.3 🥉 Phase 2C：長期検討機能

#### 2.3.1 個別化学習エンジン
**機能概要**:
- 適応タイマー（子供の回答パターンに応じた制限時間調整）
- 学習スタイル診断（視覚型・聴覚型等の特性分析）
- AI推奨問題（機械学習による最適問題選択）

**工数見積**: 8-10週間

#### 2.3.2 社会機能
**機能概要**:
- クラスルーム連携（学校の先生が生徒進捗確認）
- フレンド機能（友達同士の進捗比較）
- ランキング（地域・年齢別、匿名）

**工数見積**: 10-12週間（サーバーサイド開発含む）

## 3. 技術実装ガイドライン

### 3.1 アーキテクチャ原則

#### SVVS パターン継続
- 既存のStore-View-ViewStateパターンを新機能でも維持
- DataStoreシングルトンによるデータアクセス統一
- 新機能のViewStateも@MainActor準拠

#### SwiftDataモデル設計
```swift
// 新規モデル例
@Model
class ProgressVisualization {
    var userLevel: Int
    var totalExperience: Int
    var currentStreak: Int
    var lastPlayDate: Date
    // 既存モデルとの関連は外部キーではなくIDで管理
}
```

### 3.2 UI/UXガイドライン

#### デザインシステム継続
- 既存のColors.swift, Typography.swiftを拡張
- 小学2年生レベルの平易な日本語使用
- カラフルで親しみやすいデザイン
- アクセシビリティ対応（VoiceOver等）

#### アニメーション方針
- SwiftUIネイティブアニメーション活用
- 過度な演出は避け、学習の邪魔にならない配慮
- パフォーマンス重視（60fps維持）

### 3.3 テスト戦略

#### swift-testing継続
- 新機能のViewStateテストは@MainActor必須
- データモデルの単体テスト充実
- UI自動テストでのクリティカルパス検証

#### データ移行
- 既存ユーザーデータの完全保護
- SwiftDataスキーママイグレーション計画
- バックアップ・復元機能の検討

### 3.4 パフォーマンス考慮

#### アプリサイズ管理
- アバター画像等のアセット最適化
- オンデマンドリソース活用検討
- 不要機能の段階的削除

#### メモリ・CPU効率
- 統計計算の最適化（キャッシュ活用）
- アニメーションのメモリリーク防止
- バックグラウンド処理の適切な制御

## 4. 実装ロードマップ

### 4.1 Phase 2A：基盤強化（3-4週間）
```
週1-2: 子供向け進捗可視化システム
│     ├ 九九マスターマップUI実装
│     ├ 進捗バー・チャレンジ機能
│     └ データモデル拡張・テスト
│
週3-4: 親子間コミュニケーション機能
      ├ メッセージ送受信システム
      ├ がんばりレポート機能
      └ 通知・音声機能統合
```

### 4.2 Phase 2B：体験向上（8-10週間）
```
週5-8: ゲーミフィケーション要素
│     ├ レベル・バッジシステム
│     ├ アバター・着せ替え機能
│     └ 実績判定ロジック
│
週9-12: 学習モード拡張
       ├ ストーリーモード基本実装
       ├ ローカル対戦機能
       └ 復習モード・忘却曲線
```

### 4.3 Phase 2C：高度化（6ヶ月〜1年）
```
長期実装: 個別化・社会機能
├ AI学習エンジン研究・開発
├ サーバーサイド基盤構築
└ プライバシー・セキュリティ強化
```

## 5. リスク管理・品質保証

### 5.1 技術リスク
- **データ整合性**: 新旧モデル間の整合性確保
- **パフォーマンス**: 機能追加によるアプリ重量化防止
- **互換性**: iOS最新版・旧版での動作保証

### 5.2 UXリスク
- **学習効果**: ゲーム要素が学習の妨げにならない配慮
- **プライバシー**: 親子間データ共有の適切な制御
- **アクセシビリティ**: 障害を持つ子供への配慮

### 5.3 品質保証計画
- 段階的リリース（ベータテスト→段階展開）
- 実際の親子でのユーザビリティテスト
- 学習効果の定量的測定・評価

## 6. 成功指標・KPI

### 6.1 ユーザー体験指標
- **継続率**: 7日継続率、30日継続率の向上
- **学習効率**: 問題習得速度の改善
- **満足度**: アプリストアレビュー評価向上

### 6.2 機能別指標
- **進捗可視化**: マップ閲覧率、チャレンジ達成率
- **親子コミュニケーション**: メッセージ送受信頻度、レポート共有率
- **ゲーミフィケーション**: レベルアップ率、バッジ収集率

### 6.3 学習効果指標
- **習熟度向上**: 段別正解率の改善度
- **苦手克服**: DifficultQuestion解消率
- **定着率**: 長期記憶への定着度測定

---

**文書作成日**: 2025年7月13日  
**次回更新予定**: Phase 2A実装完了時  
**関連ドキュメント**: `CLAUDE.md`, `.claude/workspace/task.md`

この要件仕様書は、九九アプリの次期フェーズ開発において、機能企画・技術実装・品質保証の全側面をカバーしています。優先順位に従って段階的に実装することで、確実にユーザー体験を向上させ、長期的な学習継続を支援できます。