# Task: Phase 2B ゲーミフィケーション要素実装

## 目的・背景
Phase 2Aの進捗可視化・親子コミュニケーション機能が完了し、次はPhase 2Bの最優先機能である**ゲーミフィケーション要素**の実装が必要。現在のアプリは基本的な学習機能・統計機能は充実しているが、長期的な学習継続意欲を高めるためのレベルシステム・称号システムが不足している。

## 成功基準
- [ ] レベルシステム（Lv.1-50）が完全に動作する
- [ ] 経験値計算・レベルアップ処理が正確に動作する（5*level² + 5*level - 10）
- [ ] 称号システム（九九みならい〜九九レジェンド）が実装される
- [ ] レベルアップ時の視覚的フィードバック（アニメーション）が動作する
- [ ] 苦手問題へのボーナス経験値（2倍）が正しく付与される
- [ ] 全機能がビルドエラーなく動作する
- [ ] 既存機能（統計・進捗可視化等）への影響がない

## 実装計画

### Phase 1: 調査・設計
- [ ] 現在のアプリアーキテクチャ（SVVS）調査
- [ ] 既存のUserPointsモデル・統計機能調査
- [ ] レベルシステムのデータモデル設計
- [ ] 経験値計算アルゴリズム設計（要件：5*level² + 5*level - 10）
- [ ] 称号システム（7段階）の定義・設計

### Phase 2: データモデル実装
- [ ] UserLevelモデル（SwiftData）の実装
- [ ] TitleType enum（称号システム）の実装
- [ ] DataStoreへのレベル管理機能追加
- [ ] 経験値計算・レベルアップ判定ロジック実装

### Phase 3: ViewState実装
- [ ] LevelSystemViewState（@MainActor）の実装
- [ ] 既存ViewStateへのレベル連携機能追加
- [ ] レベルアップ時の状態管理・通知機能

### Phase 4: UI実装
- [ ] レベル表示UI（ホーム画面）の実装
- [ ] レベルアップアニメーション実装
- [ ] 称号表示・変更UI実装
- [ ] 経験値バー・プログレス表示

### Phase 5: 既存機能との統合
- [ ] 問題回答時の経験値付与処理統合
- [ ] 苦手問題判定システムとの連携（2倍経験値）
- [ ] 統計画面へのレベル情報表示
- [ ] 親用ダッシュボードへのレベル情報追加

### Phase 6: 検証・テスト
- [ ] swift-testingによるデータモデルテスト
- [ ] ViewStateテスト（@MainActor）の実装
- [ ] レベルアップ・経験値計算の動作検証
- [ ] 既存機能への影響確認テスト

## 注意事項

### 技術的注意点
- **SwiftData**: 既存のUserPointsモデルとの整合性確保
- **SVVS架構**: 既存のStore-View-ViewStateパターン継続
- **@MainActor**: 新規ViewStateは必ず@MainActor準拠
- **経験値計算**: 5*level² + 5*level - 10 の二次曲線を正確に実装
- **称号システム**: 7段階（九九みならい→九九せんし→九九マスター→九九エキスパート→九九レジェンド→九九チャンピオン→九九ゴッド）

### UI/UX注意点
- **小学2年生対応**: 平易な日本語・直感的なUI
- **既存レイアウト**: ホーム画面の既存コンポーネントと調和
- **パフォーマンス**: レベルアップアニメーションが60fps維持
- **ローカライゼーション**: 日英二言語対応必須

### データ整合性注意点
- **既存ユーザーデータ**: 初回起動時のレベル初期化処理
- **統計データ**: MasteryProgressとの連携確保
- **リアルタイム更新**: 問題回答時の即座な経験値・レベル反映

## 技術要素
- **使用技術**: SwiftUI, SwiftData, AVFoundation（サウンド）
- **対象ファイル**: 
  - Models/UserLevel.swift（新規）
  - Models/TitleType.swift（新規）
  - ViewStates/LevelSystemViewState.swift（新規）
  - Views/Components/LevelDisplayView.swift（新規）
  - Views/Components/LevelUpAnimationView.swift（新規）
  - Views/ContentView.swift（更新）
  - DataStore.swift（更新）
  - MultiplicationViewState.swift（更新 - 経験値付与処理）
- **作業範囲**: フロントエンド中心（データモデル〜UI実装まで）

## 進捗メモ
- 開始日: 2025年7月18日
- 要件確認: Phase 2A完了、Phase 2B実装が推奨段階
- 現状調査: SVVS架構・SwiftDataモデル・既存ViewState確認が必要
- 最優先: レベルシステム実装（称号システム・経験値計算）
- 実装方針: 既存のUserPointsとの整合性を保ちながら、新規レベルシステムを追加